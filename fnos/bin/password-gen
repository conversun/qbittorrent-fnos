#!/bin/sh
# Generate qBittorrent PBKDF2-SHA512 password hash
# Usage: password-gen <password>
# Output: @ByteArray(salt:hash) format for qBittorrent.conf

if [ -z "$1" ]; then
    echo "Usage: $0 <password>" >&2
    exit 1
fi

PASSWORD="$1"

# Generate 16-byte random salt
SALT=$(openssl rand -base64 16 | tr -d '\n' | cut -c1-24)

# Generate PBKDF2-SHA512 hash (100000 iterations, 64-byte output)
# Note: openssl kdf requires OpenSSL 3.0+, fallback to python if not available
if openssl kdf -keylen 64 -kdfopt digest:SHA512 -kdfopt iter:100000 -kdfopt pass:"$PASSWORD" -kdfopt hexsalt:"$(echo -n "$SALT" | base64 -d | xxd -p | tr -d '\n')" PBKDF2 2>/dev/null | xxd -r -p | base64 | tr -d '\n' > /tmp/qb_hash_$$ 2>/dev/null; then
    HASH=$(cat /tmp/qb_hash_$$)
    rm -f /tmp/qb_hash_$$
else
    # Fallback to Python (more portable)
    HASH=$(python3 -c "
import hashlib
import base64
import sys

password = sys.argv[1]
salt = base64.b64decode(sys.argv[2])
dk = hashlib.pbkdf2_hmac('sha512', password.encode(), salt, 100000, dklen=64)
print(base64.b64encode(dk).decode(), end='')
" "$PASSWORD" "$SALT" 2>/dev/null)
fi

if [ -z "$HASH" ]; then
    echo "Error: Failed to generate password hash" >&2
    exit 1
fi

echo "@ByteArray(${SALT}:${HASH})"
